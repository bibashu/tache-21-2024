<!DOCTYPE html>
<html lang="fr">


  
  <%- include('../pages/head.ejs') %>
  <body>
  <%- include('../pages/navbar.ejs') %>
  <div class="container-fluid mt-5">

    <!-- Sidebar -->
    <%- include('../pages/sidebar.ejs') %>
    <!-- End Sidebar -->
    
    <div class="card shadow-sm" style="max-width: 600px; margin: 0 auto; padding: 20px;">
      <div class="text-center">
        <!-- Image de profil de l'utilisateur -->
        <img id="profile-picture" src="/assets/img/profile.jpg" class="rounded-circle mb-3" alt="Profile Image"
          style="width: 150px; height: 150px; object-fit: cover;" />
        <p class="fw-bold">Bienvenue sur votre profil.</p>
      </div>
  
      <!-- Formulaire pour télécharger une nouvelle image -->
      <form id="profile-picture-form" enctype="multipart/form-data" class="mt-2">
        <label for="profilePictureInput" class="form-label">Télécharger une photo de profil</label>
        <input type="file" id="profilePictureInput" name="profilePicture" accept="image/*" class="form-control mb-3">
        <button type="submit" class="btn rounded-3 text-white mb-3"
        style="background-color: #FB924F">Mettre à jour la photo</button>
      </form>
  
      <div class="px-5 text-black">
        <h4>Nom d'utilisateur: <span id="username-big">Chargement...</span></h4>
        <p>Email: <span id="email">Chargement...</span></p>
      </div>
    
  </div>



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // console.log('Script exécuté'); // Vérification du chargement du script

      const token = localStorage.getItem('token');
      // console.log('Token récupéré:', token); // Vérification du token

      if (!token) {
        alert('Token manquant. Veuillez vous connecter.');
        window.location.href = '/authentification/login';
        return;
      }

      fetch('/api/profil', { // Utiliser la route API correcte
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
        .then(response => {
          if (response.status === 401) {
            // Rediriger vers la page de login si non autorisé
            window.location.href = '/authentification/login';
            return;
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            alert(data.error);
          } else {
            document.getElementById('username-big').textContent = data.username;
            document.getElementById('email').textContent = data.email;
          }
        })
        .catch(err => console.error('Erreur dans la requête fetch:', err));
    });


    // Écouteur pour le formulaire de téléchargement de la photo de profil
    document.getElementById('profile-picture-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData();
      const fileInput = document.getElementById('profilePictureInput');

      if (fileInput.files.length > 0) {
        formData.append('profilePicture', fileInput.files[0]);
      }

      fetch('/upload-profile-picture', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.filePath) {
            document.getElementById('profile-picture').src = data.filePath;
          }
        })
        .catch(error => console.error('Erreur:', error));
    });
  </script>
</body>

</html>